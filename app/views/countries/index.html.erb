<div id="orange-home-page-banner">
  <div class="container">
    <div class="row">
        <div class="col-md-6 d-none d-md-block">
          <p class="text-banner-one">
            <span id="banner-typed-text"></span>
          </p>
        </div>
        <div class="col-12-text-center col-md-6">
          <h3 class="text-banner-two">Navigate entry restrictions and quarantine requirements for any destination with our live map.</h3>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Create an element where the map will take place -->
<div class="row">
  <div class="col-md-8">
    <svg id="my_dataviz" width="800" height="500" data-countries="<%= @json_array %>"></svg>
  </div>

  <div class="col-md-4">
    <div id="info">
      <h3 id="title" >Click on a country to explore</h3>
      <h4 id="status"></h4>
      <h4 id="test"></h4>
      <h4 id="quarantine"></h4>
      <h4 id="color"></h4>
      <h4 id="content"></h4>
      <span id="link"></span>
    </div>
  </div>
</div>

<script>
// The svg
const svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

// Map and projection
const projection = d3.geoNaturalEarth1()
    .scale(width / 0.4 / Math.PI)
    .translate([width / 2, height / 2])
    .center([10,50])

var g = svg.append("g");
let path = d3.geoPath().projection(projection);
let countryByIso = d3.map(); // Will let us access country data by ISO code

// Load external data and boot
var myJsArray = JSON.parse(  document.getElementById("my_dataviz").dataset.countries  )
console.log(myJsArray);

d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(data){

    // Draw the map
    g.append("g")
        .attr("id", "countries")
        .selectAll("path") // Select path
        .data(data.features)  // Bind geodata
        .enter()
        .append("path")  // Add svg path for each country
        .attr("country", function(d) { return d.properties.name; })
        .attr("fill", function (d){
          // console.log(d.properties.name);
          // console.log(myJsArray[d.properties.name]);

          if (myJsArray[d.properties.name])
          {
            console.log(d.properties.name);
            console.log(myJsArray[d.properties.name]);
            return "#55A630";
          }
          else
          {
            return "#BBB"
          }
        })
        .style("stroke", "#fff")
        .attr("d", path) // Send geometry data to path function to plot points
        .on("click", function(d){
          console.log(d);
          d3.select('#title').html(''); // Empty old data from the info page
          d3.select('#color').html(''); // Empty old data from the info page
          d3.select('#status').html(''); // Empty old data from the info page
          d3.select('#content').html(''); // Empty old data from the info page
          d3.select('#test').html(''); // Empty old data from the info page
          d3.select('#quarantine').html(''); // Empty old data from the info page

          d3.select('#title').html(d.properties.name);
          if (myJsArray[d.properties.name])
          {
            // d3.select('#status').html(myJsArray[d.properties.name].["status"];
            d3.select('#test').html("Requires test no older than: " + myJsArray[d.properties.name]["test"]);
            d3.select('#quarantine').html("At destination isolate for: " + myJsArray[d.properties.name]["quarantine"]);
            d3.select('#color').html("UK quarantine tier color: " + myJsArray[d.properties.name]["color"]);
            // d3.select('#content').html(myJsArray[d.properties.name]["content"]);
            var id = myJsArray[d.properties.name]["id"];
            d3.select("#link").html(`<a href="/countries/${id}">More Info</a>`);
          }
          else
          {
            d3.select('#status').html("Closed to Tourists");
          }
        });
})

</script>

  <div class="bg-white m-0">
    <div class="container text-center">
      <div class="row">
        <h1 class="col-12 mt-4">Solutions for travelers during the COVID-19 pandemic</h1>
      </div>
    </div>
    <div class="container text-center">
      <div class="row d-flex justify-content-between">
        <div class="col-12 col-md-3 card">
          <img src="https://www.kiwi.com/images/hero/icon-self-service.svg" class="card-img-top rounded mx-auto d-block" alt="...">
          <div class="card-body">
            <p class="card-text">Set up alerts to get notified by email when a country's policy changes</p>
            <br>
            <% if user_signed_in? %>
              <%= link_to "Manage Alerts", user_path(current_user), class: 'btn'  %>
            <% else %>
              <a type="button" href="users/sign_in" class="btn">Manage alerts</a>
            <% end %>
          </div>
        </div>
        <div class="col-12 col-md-3 card">
          <img src="https://www.kiwi.com/images/hero/icon-information.svg" class="card-img-top rounded mx-auto d-block" alt="...">
          <div class="card-body">
            <p class="card-text">Compare countries' Coronavirus restrictions data.</p>
            <br>
            <a type="button" href="countries/compare" class="btn">Compare countries</a>
          </div>
        </div>
        <div class=" col-12 col-md-3 card">
          <img src="https://www.kiwi.com/images/hero/icon-covid.svg" class="card-img-top rounded mx-auto d-block" alt="...">
          <div class="card-body">
            <p class="card-text">Explore flights with our partner Kiwi</p>
            <br>
            <a type="button" href="#" class="btn">Explore flights</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div>
    <div id="widget-holder"></div>
    <script
    data-affilid="rodrigotravelcolor"
    data-results-only="true"
    src="https://widgets.kiwi.com/scripts/widget-search-iframe.js">
    </script>
  </div>
</div>
